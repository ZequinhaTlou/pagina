<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#1b263b" />

<title>Compras do M√™s</title>
<style>
  /* Estilo para os campos opcionais de mercado e dinheiro total */
  #mercado, #dinheiroTotal {
    display: block;
    width: 80%;
    max-width: 400px;
    margin: 10px auto 20px auto;
    padding: 12px 15px;
    font-size: 1.1em;
    background-color: #223254; /* tom mais escuro que os inputs normais */
    border: 2px solid #4da3ff; /* borda azul clara */
    border-radius: 12px;
    color: #a9d1ff;
    box-shadow: 0 0 10px #4da3ff44; /* brilho azul suave */
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    font-variant-ligatures: none; /* desativa ligadura */
  }

  #mercado:focus, #dinheiroTotal:focus {
    outline: none;
    border-color: #2ecc71; /* verde vivo no foco */
    box-shadow: 0 0 12px #2ecc7144;
    background-color: #1b263b;
    color: #d0e9ff;
    font-weight: 600;
  }

  body {
    font-family: Arial, sans-serif;
    background-color: #0d1b2a;
    color: #fff;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    font-variant-ligatures: none; /* desativa ligadura no body todo */
  }
  header {
    background-color: #1b263b;
    text-align: center;
    padding: 15px;
  }
  header h1 {
    margin: 5px 0;
  }
  header p {
    font-size: 0.9em;
    color: #ccc;
  }
  .card {
    background: #182538;
    padding: 15px;
    border-radius: 10px;
    max-width: 900px;
    margin: 15px auto;
    overflow-x: auto;
  }
  form {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  input, button {
    padding: 10px;
    border: none;
    border-radius: 5px;
    font-size: 1em;
    font-variant-ligatures: none;
  }
  input {
    background-color: #1e2e46;
    color: #fff;
  }
  button.add {
    background-color: #2ecc71;
    color: white;
    font-weight: bold;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 0.95em;
  }
  th, td {
    padding: 8px;
    text-align: left;
  }
  th {
    color: #ccc;
  }
  td {
    border-top: 1px solid #2c3e50;
  }
  td.quantidade {
    text-align: center;
  }
  td.acoes {
    text-align: center;
  }
  button.edit, button.delete {
    padding: 5px 8px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
    margin: 0 2px;
  }
  button.edit {
    background-color: #f1c40f;
    color: #000;
  }
  button.delete {
    background-color: #e74c3c;
    color: white;
  }
  tfoot td {
    font-weight: bold;
    color: #4da3ff;
  }
  .pdf-btn {
    margin-top: 10px;
    background-color: #3498db;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
  }
  .file-btn {
    margin-top: 10px;
    background-color: #9b59b6;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    margin-left: 10px;
  }
  footer {
    text-align: center;
    padding: 10px;
    background-color: #1b263b;
    font-size: 0.85em;
    margin-top: auto;
    color: #aaa;
  }
  .buttons-container {
    display: flex;
    justify-content: flex-start;
    gap: 10px;
    margin-top: 10px;
    flex-wrap: wrap;
  }
  /* nova classe para exibir o saldo restante */
  .saldo {
    margin-top: 10px;
    font-weight: bold;
    color: #2ecc71;
  }
  /* Bot√£o apagar tudo */
  button.clear-all {
    background-color: #e67e22;
    color: white;
    font-weight: bold;
  }
</style>
</head>
<body>

<header>
  <h1>Compras do M√™s</h1>
  <p>Adicione, edite e remova itens. Salve em PDF para manter seu controle de compras.</p>
</header>

<div class="card">

  <input type="text" id="mercado" placeholder="Nome do mercado (opcional)" />
  <input type="number" id="dinheiroTotal" placeholder="Dinheiro total para gastos (opcional)" min="0" step="0.01" />

  <form id="form">
    <input type="text" id="produto" placeholder="Produto (ex: Arroz ou Ma√ß√£)" required />
    <input type="number" id="quantidade" placeholder="Quantidade" min="0.1" step="0.1" required />
    <input type="number" id="valor" placeholder="Valor unit√°rio" step="0.01" required />
    <button type="submit" class="add">Adicionar</button>
  </form>

  <table id="tabela">
    <thead>
      <tr>
        <th>Produto</th>
        <th>Quantidade</th>
        <th>Valor Unit.</th>
        <th>Total</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <td colspan="4">TOTAL</td>
        <td id="totalGeral">R$ 0,00</td>
      </tr>
    </tfoot>
  </table>

  <div id="saldoRestante" class="saldo" style="display:none;"></div>

  <div class="buttons-container">
    <button class="pdf-btn" onclick="exportarPDF()">üìù Exportar PDF</button>
    <button class="file-btn" onclick="salvarArquivo()">üíº Salvar arquivo</button>
    <button class="file-btn" onclick="document.getElementById('inputFile').click()">üìÇ Abrir arquivo</button>
    <button class="clear-all" onclick="apagarTudo()">üóëÔ∏è Apagar Tudo</button>
    <input type="file" id="inputFile" accept=".json" style="display:none" />
  </div>
</div>

<footer>
  Criado por Bruno Deringer üôÇ
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  let itens = [];
  let editIndex = -1;

  const form = document.getElementById('form');
  const inputFile = document.getElementById('inputFile');

  /* Carrega dados do localStorage */
  function carregarLocalStorage() {
    const dados = localStorage.getItem('comprasDados');
    if (dados) {
      try {
        const obj = JSON.parse(dados);
        if(obj.itens && Array.isArray(obj.itens)){
          itens = obj.itens;
          document.getElementById('mercado').value = obj.mercado || '';
          document.getElementById('dinheiroTotal').value = (obj.dinheiroTotal !== undefined && obj.dinheiroTotal !== null) ? obj.dinheiroTotal : '';
          atualizarTabela();
        }
      } catch {
        // Ignorar erro se JSON inv√°lido
      }
    }
  }

  /* Salva dados no localStorage */
  function salvarLocalStorage() {
    const mercado = document.getElementById('mercado').value.trim() || null;
    const dinheiroTotalVal = document.getElementById('dinheiroTotal').value;
    const dinheiroTotal = (dinheiroTotalVal !== '') ? parseFloat(dinheiroTotalVal) : null;
    const dadosParaSalvar = {
      mercado,
      dinheiroTotal,
      itens
    };
    localStorage.setItem('comprasDados', JSON.stringify(dadosParaSalvar));
  }

  /* Atualiza tabela e salva automaticamente */
  function atualizarTabela(){
    let tbody = document.querySelector('#tabela tbody');
    tbody.innerHTML = '';
    let totalGeral = 0;
    itens.forEach((item, index) => {
      let total = item.quantidade * item.valor;
      totalGeral += total;
      tbody.innerHTML += `
        <tr>
          <td>${item.produto}</td>
          <td class="quantidade">${item.quantidade}</td>
          <td>R$ ${item.valor.toFixed(2).replace('.', ',')}</td>
          <td>R$ ${total.toFixed(2).replace('.', ',')}</td>
          <td class="acoes">
            <button class="edit" onclick="editarItem(${index})" aria-label="Editar item">‚úÖ</button>
            <button class="delete" onclick="removerItem(${index})" aria-label="Remover item">‚ùå</button>
          </td>
        </tr>
      `;
    });
    document.getElementById('totalGeral').innerText = "R$ " + totalGeral.toFixed(2).replace('.', ',');

    const dinheiroTotalVal = document.getElementById('dinheiroTotal').value;
    const saldoDiv = document.getElementById('saldoRestante');
    if(dinheiroTotalVal !== ''){
      const dinheiroTotal = parseFloat(dinheiroTotalVal);
      if(!isNaN(dinheiroTotal)){
        const sobra = dinheiroTotal - totalGeral;
        saldoDiv.style.display = 'block';
        saldoDiv.innerText = `üí∞ Dinheiro que sobra: R$ ${sobra.toFixed(2).replace('.', ',')}`;
      } else {
        saldoDiv.style.display = 'none';
        saldoDiv.innerText = '';
      }
    } else {
      saldoDiv.style.display = 'none';
      saldoDiv.innerText = '';
    }

    salvarLocalStorage();
  }

  form.addEventListener('submit', function(e){
    e.preventDefault();
    let produto = document.getElementById('produto').value.trim();
    let quantidade = parseFloat(document.getElementById('quantidade').value);
    let valor = parseFloat(document.getElementById('valor').value);

    if(!produto || quantidade <= 0 || valor <= 0){
      alert("Por favor, preencha os campos corretamente.");
      return;
    }

    if(editIndex === -1){
      itens.push({produto, quantidade, valor});
    } else {
      itens[editIndex] = {produto, quantidade, valor};
      editIndex = -1;
    }
    atualizarTabela();
    this.reset();
  });

  function editarItem(index){
    document.getElementById('produto').value = itens[index].produto;
    document.getElementById('quantidade').value = itens[index].quantidade;
    document.getElementById('valor').value = itens[index].valor;
    editIndex = index;
  }

  function removerItem(index){
    if(confirm("Deseja remover este item?")){
      itens.splice(index, 1);
      atualizarTabela();
    }
  }

  function apagarTudo(){
    if(confirm("Tem certeza que deseja apagar todos os itens?")){
      itens = [];
      atualizarTabela();
      document.getElementById('mercado').value = '';
      document.getElementById('dinheiroTotal').value = '';
    }
  }

  function formatarDataParaNomeArquivo(data){
    const pad = (n) => n.toString().padStart(2, '0');
    const dia = pad(data.getDate());
    const mes = pad(data.getMonth() + 1);
    const ano = data.getFullYear();
    const hora = pad(data.getHours());
    const min = pad(data.getMinutes());
    const seg = pad(data.getSeconds());
    return `${dia}-${mes}-${ano}_${hora}-${min}-${seg}`;
  }

  function salvarArquivo(){
    if(itens.length === 0){
      alert("Nenhum item para salvar.");
      return;
    }
    const dataAtual = new Date();
    const dataFormatada = dataAtual.toLocaleDateString('pt-BR') + ' ' + dataAtual.toLocaleTimeString('pt-BR');

    const mercado = document.getElementById('mercado').value.trim() || null;
    const dinheiroTotalVal = document.getElementById('dinheiroTotal').value;
    const dinheiroTotal = (dinheiroTotalVal !== '') ? parseFloat(dinheiroTotalVal) : null;

    const totalGeral = itens.reduce((acc, i) => acc + i.quantidade * i.valor, 0);
    const sobra = (dinheiroTotal !== null && !isNaN(dinheiroTotal)) ? parseFloat((dinheiroTotal - totalGeral).toFixed(2)) : null;

    const dadosParaSalvar = {
      dataCompra: dataFormatada,
      mercado: mercado,
      dinheiroTotal: dinheiroTotal,
      sobra: sobra,
      itens: itens
    };

    const dados = JSON.stringify(dadosParaSalvar, null, 2);
    const blob = new Blob([dados], {type: "application/json"});
    const url = URL.createObjectURL(blob);

    const dataHoraNome = formatarDataParaNomeArquivo(dataAtual);
    const nomeArquivo = `compras_${dataHoraNome}.json`;

    const a = document.createElement('a');
    a.href = url;
    a.download = nomeArquivo;
    a.click();
    URL.revokeObjectURL(url);
  }

  function exportarPDF(){
    if(itens.length === 0){
      alert("Nenhum item para exportar.");
      return;
    }
    const { jsPDF } = window.jspdf;
    let doc = new jsPDF();
    const dataAtual = new Date();

    doc.setFontSize(18);
    doc.text("Lista de Compras do M√™s", 10, 10);

    const dataFormatada = dataAtual.toLocaleDateString('pt-BR') + ' ' + dataAtual.toLocaleTimeString('pt-BR');
    doc.setFontSize(12);
    doc.text(`Data da compra: ${dataFormatada}`, 10, 18);

    let y = 28;

    const mercado = document.getElementById('mercado').value.trim();
    const dinheiroTotalVal = document.getElementById('dinheiroTotal').value;
    const dinheiroTotal = (dinheiroTotalVal !== '') ? parseFloat(dinheiroTotalVal) : null;

    if(mercado){
      doc.text(`Mercado: ${mercado}`, 10, y);
      y += 8;
    }
    if(dinheiroTotal !== null && !isNaN(dinheiroTotal)){
      doc.text(`Dinheiro total: R$ ${dinheiroTotal.toFixed(2).replace('.', ',')}`, 10, y);
      y += 8;
    }
    
    itens.forEach(item => {
      let linha = `${item.produto} - Qtd: ${item.quantidade} - Unit: R$ ${item.valor.toFixed(2).replace('.', ',')} - Total: R$ ${(item.quantidade * item.valor).toFixed(2).replace('.', ',')}`;
      doc.text(linha, 10, y);
      y += 10;
      if(y > 280){
        doc.addPage();
        y = 10;
      }
    });
    const totalGeral = itens.reduce((acc, i) => acc + i.quantidade * i.valor, 0);
    doc.text(`TOTAL: R$ ${totalGeral.toFixed(2).replace('.', ',')}`, 10, y + 10);

    if(dinheiroTotal !== null && !isNaN(dinheiroTotal)){
      const sobra = dinheiroTotal - totalGeral;
      doc.text(`Dinheiro que sobra: R$ ${sobra.toFixed(2).replace('.', ',')}`, 10, y + 18);
    }

    doc.save(`lista_compras_${formatarDataParaNomeArquivo(dataAtual)}.pdf`);
  }

  /* Abrir arquivo JSON */
  inputFile.addEventListener('change', e => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = evt => {
      try {
        const data = JSON.parse(evt.target.result);
        if(data.itens && Array.isArray(data.itens)){
          itens = data.itens;
          document.getElementById('mercado').value = data.mercado || '';
          document.getElementById('dinheiroTotal').value = (data.dinheiroTotal !== undefined && data.dinheiroTotal !== null) ? data.dinheiroTotal : '';
          atualizarTabela();
        } else {
          alert('Arquivo inv√°lido!');
        }
      } catch {
        alert('Erro ao ler o arquivo!');
      }
    };
    reader.readAsText(file);
    // limpa o input para poder abrir o mesmo arquivo novamente, se quiser
    e.target.value = '';
  });

  /* Atualiza saldo se mudar dinheiro total ou mercado */
  document.getElementById('dinheiroTotal').addEventListener('input', atualizarTabela);
  document.getElementById('mercado').addEventListener('input', salvarLocalStorage);

  // Inicializa√ß√£o do aplicativo
  window.onload = function() {
    carregarLocalStorage();
    atualizarTabela();
  }
</script>

</body>
</html>